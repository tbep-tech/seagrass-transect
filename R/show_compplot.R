#' Make a bar plot for transect group comparisons
#'
#' @param dat data frame returned by \code{\link{form_trnjsn}}
#' @param site chr string indicating site results to plot
#' @param species chr string indicating which species to plot
#' @param varplo chr string indicating which variable to plot 
#' @param base_size numeric indicating text scaling size for plot
#' @param xtxt numeric indicating text size for x-axis labels
#'
#' @return A \code{\link[ggplot2]{ggplot}} object
#' @export
#'
#' @examples
#' trnjsn <- read_trnjsn()
#' dat <- form_trnjsn(trnjsn)
#' show_compplot(dat, site = '1', species = 'Halodule', varplo = 'Abundance')
show_compplot <- function(dat, site, species = c('Halodule', 'Ruppia', 'Syringodium', 'Thalassia'), 
                          varplo = c('Abundance', 'Blade Length', 'Short Shoot Density'), base_size = 18, xtxt = 10){

  # arguments
  species <- match.arg(species)
  varplo <- match.arg(varplo)
  
  # labels
  lbs <- c('Braun-Blanquet Score', 'Canopy Height (+/- 1 sd)', 'Short Shoot Counts (+/- 1 sd)')
  names(lbs) <- c('Abundance', 'Blade Length', 'Short Shoot Density')
  xlb <- lbs[[varplo]]
  ttl <- paste('Site', site)
  sublbs <- c('Halodule wrightii', 'Ruppia maritima', 'Syringodium filiforme', 'Thalassia testidinum')
  names(sublbs) <- c('Halodule', 'Ruppia', 'Syringodium', 'Thalassia')
  subttl <- sublbs[[species]]
  
  # data to plot
  toplo <- dat %>% 
    dplyr::filter(Site %in% site) %>% 
    dplyr::filter(Savspecies %in% species) %>% 
    dplyr::filter(var %in% varplo) %>% 
    dplyr::mutate(
      grp = paste0(MonitoringAgency, ' (', Crew, ')'),
      grp = gsub('(.{1,12})(\\s|$)', '\\1\n', grp), 
      grp = gsub('\\n*$', '', grp)
      )

  # get summary stats
  sumplo <- toplo %>% 
    dplyr::group_by(var) %>% 
    dplyr::summarise(
      Median = median(aveval, na.rm = TRUE), 
      Average = mean(aveval, na.rm = TRUE)
    ) %>% 
    tidyr::gather('sumvar', 'sumval', Median, Average)
  
  # plot
  p <- ggplot2::ggplot(toplo, ggplot2::aes(x = grp, y = aveval)) + 
    ggplot2::geom_bar(stat = 'identity', alpha = 0.7) + 
    ggplot2::labs(
      y = xlb, 
      title = ttl, 
      subtitle = bquote(italic(.(subttl)))
    ) + 
    # ggplot2::guides(x = ggplot2::guide_axis(n.dodge = 2)) + 
    ggplot2::scale_y_continuous(expand = c(0, 0)) + 
    ggplot2::theme_bw(base_size = base_size) + 
    ggplot2::theme(
      panel.border = ggplot2::element_blank(),
      axis.title.x = ggplot2::element_blank(), 
      axis.text.x = ggplot2::element_text(size = xtxt),
      panel.grid.major.x = ggplot2::element_blank(), 
      panel.grid.minor.x = ggplot2::element_blank(), 
      legend.title = ggplot2::element_blank(), 
      legend.position = 'bottom'
    )
    
  # add error bar and both summary lines if not abundance
  if(!varplo %in% 'Abundance'){ 
      
    p <- p + 
      ggplot2::geom_errorbar(ggplot2::aes(ymin = aveval - sdval, ymax = aveval + sdval), width = 0.25) +
      ggplot2::geom_hline(data = sumplo, ggplot2::aes(yintercept = sumval, linetype = sumvar), color = 'red')
    
  }
  
  # add mean summary lines if abundance
  if(varplo %in% 'Abundance'){
    
    sumplo <- sumplo %>% 
      dplyr::filter(sumvar %in% 'Average') 
    
    p <- p + 
      ggplot2::geom_hline(data = sumplo, ggplot2::aes(yintercept = sumval, linetype = sumvar), color = 'red')
    
  }
  
  return(p)

}