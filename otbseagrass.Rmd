---
output: 
  html_document
css: styles.css
runtime: shiny
---
  
```{r message = F, warning = F, echo = F}
knitr::opts_chunk$set(echo = F, warning = F, message = F, fig.path = 'figures/')

library(tbeptools)
library(tidyverse)
library(lubridate)
library(plotly)
library(htmltools)
library(shiny)
library(mapview)
library(leaflet)
library(sf)
library(extrafont)

source('R/funcs.R')

data(trnpts)
data(tbsegshed)
data(otbtrn)
data(algdat)

loadfonts(device = 'pdf', quiet = T)
if(Sys.info()[1] == 'Windows')
  loadfonts(device = 'win', quiet = T)

fml <- 'Lato Light'

otbshed <- tbsegshed %>% 
  filter(bay_segment %in% 'OTB')
otbpts <- trnpts[otbshed, ]

wqstat <- stations %>% 
  filter(bay_segment %in% 'OTB')

algdat <- algdat %>% 
  filter(yr >= 1998)

epcdata <- epcdata %>% 
  filter(yr >= 1998) %>% 
  mutate(
    sd_q = case_when(
      is.na(sd_q) ~ T, 
      !is.na(sd_q) ~ F
    )
  )

algnms <- c('Bacillariophyta', 'Cyanobacteria', 'Karenia brevis', 'Pseudo-nitzschia pungens', 'Pseudo-nitzschia sp.', 'Pyrodinium bahamense', 'Tripos hircus', 'other')
cols <- pal_alg(algnms)
names(cols) <- algnms

# minor theme tweaks
pthm <- theme(
    axis.text.x = element_text(size = 11, angle = 45, hjust = 1),
    legend.text = element_text(size = 12), 
    axis.title.y = element_text(size = 12),
    text = element_text(fml), 
    legend.position = 'top',
    # panel.grid.minor=element_blank(),
    # panel.grid.major=element_blank(),
    panel.background = element_rect(fill = '#ECECEC')
    ) 

##
# get spp freq occurrence

covest <- otbtrn %>% 
  group_by(Date, Transect, Savspecies) %>% 
  nest() %>% 
  mutate(
    est = purrr::map(data, function(data){
      
      foest <- sum(data$bb > 0, na.rm = T) / nrow(data)   
      bbest <- sum(data$bb, na.rm = T) / nrow(data)
      out <- tibble(foest = foest, bbest = bbest)
      
      return(out)
      
    })
  ) %>% 
  select(-data) %>% 
  unnest(est) %>%
  ungroup %>% 
  filter(Savspecies != 'No Cover') %>% 
  mutate(
    mo = month(Date), 
    yr = year(Date), 
    dy = 15,
    Savspecies = factor(Savspecies, levels = rev(c('AA', 'DA', 'Halodule', 'Thalassia', 'Syringodium', 'Ruppia', 'Halophila spp.')))
  ) %>% 
  group_by(Savspecies, mo, yr, dy, Transect) %>% 
  summarise(
    foest = mean(foest), 
    bbest = mean(bbest)
  ) %>% 
  ungroup() %>% 
  unite('Date', yr, mo, dy, sep = '-') %>% 
  mutate(Date = ymd(Date))

m <- mapview(otbpts, homebutton = F, layer.name = 'Transects', col.regions = 'darkgreen') +
  mapview(st_as_sf(wqstat, coords = c('Longitude', 'Latitude'), crs = st_crs(tbshed)), homebutton = F, layer.name = 'EPCHC stations', col.regions = 'darkblue') 
m <- m@map
```

```{r reactives}
mapsel <- reactive({
  
  # input
  trn <- input$trn
  wqst <- input$wqst
  
  trnpt <- otbpts %>% 
    filter(TRAN_ID %in% trn)
  
  wqstpt <- wqstat %>% 
    filter(epchc_station %in% wqst)
  
  out <- m %>% 
    clearMarkers() %>% 
    addCircles(data = trnpt, ~LONG_DD, ~LAT_DD, color = 'darkgreen', weight = 20) %>% 
    addCircles(data = wqstpt, ~Longitude, ~Latitude, color = 'darkblue', weight = 20) %>% 
    addLabelOnlyMarkers(data = otbpts, ~LONG_DD, ~LAT_DD, label = ~TRAN_ID, labelOptions = labelOptions(
      noHide = T, 
      direction = 'auto', 
      textOnly = T,
      textsize = '15px',
      style = list(
        'color' = 'darkgreen'
      )
    )) %>% 
    addLabelOnlyMarkers(data = wqstat, ~Longitude, ~Latitude, label = ~epchc_station, labelOptions = labelOptions(
      noHide = T, 
      direction = 'auto', 
      textOnly = T,
      textsize = '15px',
      style = list(
        'color' = 'darkblue'
      )
    ))
  
  return(out)
  
})

# observed data plot
obsplo <- reactive({
  
  # input
  wqst <- input$wqst
  sgty <- input$sgty
  trn <- input$trn
  
  ##
  # data to plot
  
  # wq data
  wqplo <- epcdata %>% 
    filter(epchc_station %in% wqst) %>% 
    select(Date = SampleTime, sd_raw_m, sd_q, chla) %>% 
    mutate(Date = as.Date(Date))
  
  # algae data
  algplo <- algdat %>% 
    filter(epchc_station %in% wqst) %>% 
    group_by(yrqrt, name) %>%
    summarise(count = sum(count, na.rm = T)) %>% 
    ungroup %>% 
    mutate(
      name = factor(name, levels = algnms, labels = algnms)
      )

  # seagrass data
  sglab <- 'BB Abundance'
  sgval <- 'bbest'
  if(sgty == 'Freq. Occ.'){
    sglab <- 'Freq. Occ.'
    sgval <- 'foest'
  }
  sgplo <- covest %>% 
    filter(Transect %in% trn) %>% 
    rename(val = !!sgval)
  
  ##
  # plots

  # chl plot
  p1 <- plot_ly(wqplo, x = ~Date, y = ~chla, name = 'Chlorophyll-a', type= 'scatter', mode = 'lines', line = list(color = '#427355')) %>% 
    layout(
      yaxis = list(title = 'Conc. (ug/L)'),
      xaxis = list(gridcolor = '#FFFFFF'),
      showlegend = T, 
      font = list(family = fml)
    )
  
  # secchi plot
  p2 <- plot_ly(wqplo, x = ~Date) %>% 
    add_trace(y = ~sd_raw_m, name = 'Secchi depth', type= 'scatter', mode = 'lines', line = list(color = '#0047FE')) %>% 
    layout(
      yaxis = list(title = 'Depth (m)'),
      xaxis = list(gridcolor = '#FFFFFF'),
      showlegend = T, 
      font = list(family = fml)
    )
  
  if(any(!wqplo$sd_q))
    p2 <- p2 %>% 
      add_trace(data = wqplo[!wqplo$sd_q, ], x = ~Date, y = ~sd_raw_m, name = 'Secchi on bottom', type = 'scatter', mode = 'marker', marker = list(color = "#FF6347", size = 8))
  
  # algae plot
  p3 <-  plot_ly(algplo, x = ~ yrqrt, y= ~count, color = ~name, text = ~paste0(name, ', ', yrqrt), hoverinfo = 'text') %>% 
    add_bars() %>% 
    layout(
      yaxis = list(title = 'Phyto. cell count (0.1/ml)', gridcolor = '#FFFFFF'),
      barmode = 'stack',
      showlegend = T, 
      font = list(family = fml)
    )
  
  # seagrass plot
  p4 <- plot_ly(sgplo, x = ~Date, y = ~val, color = ~Savspecies, stackgroup = 'one', type = 'scatter', mode = 'none') 
  if(sgty == 'Freq. Occ.')
      p4 <- plot_ly(sgplo, x = ~Date, y = ~val, color = ~Savspecies, stackgroup = 'one', type = 'scatter', mode = 'none', groupnorm = 'percent') 

  p4 <- p4 %>% 
    layout(
      yaxis = list(title = sglab),
      xaxis = list(title = NA, gridcolor = '#FFFFFF', tickfont = list(size = 8), tickangle = 45),
      barmode = 'stack',
      showlegend = T, 
      legend = list(title = list(text = 'Seagrass'))
    )
  
  out <- subplot(p3, p1, p2, p4, nrows = 4, shareX = T, titleY = T, which_layout = 1) %>%
    layout(
      # title = paste0('Station ', wqst, ', Transect ', trn),
      # legend = list(font = list(size = 16)), 
      yaxis = list(gridcolor = '#ECECEC'),
      font = list(family = fml),
      plot_bgcolor = '#FFFFFF'
    )
  
  return(out)
  
  
  
})
```

# Old Tampa Bay Seagrass evaluation

```{r, out.width = '100%'}
output$mapsel <- renderLeaflet(mapsel())
leafletOutput('mapsel')
```

```{r}
column(12,
  column(4, selectInput('wqst', 'Select water quality station:', choices = sort(unique(wqstat$epchc_station)))), 
  column(4, selectInput('trn', 'Select transect:', choices = levels(covest$Transect))),
  column(4, selectInput('sgty', 'Select seagrass plot type:', choices = c('BB average', 'Freq. Occ.')))
)
```

<br>
<br>
<br>

```{r}
output$obsplo <- renderPlotly(obsplo())
plotlyOutput('obsplo', height = "1000px")
```